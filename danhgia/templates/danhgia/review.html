{% extends "base-customer.html" %}
{% load static %}

{% block title %}ƒê√°nh gi√° | Star Gym Fitness{% endblock %}

{% block content %}
<style>
:root {
  --color-primary: #f7c948;
  --color-text-light: #fff;
  --color-dark-card: #222;
  --color-darker-card: #1a1a1a;
}

/* PAGE TITLE */
.page-title {
  color:#fff;
  font-size: 40px;
  font-weight: 700;
  margin-bottom: 22px;
  display: flex;
  align-items: center;
  text-transform: uppercase;
}
.page-title::before {
  content: '';
  width: 6px;
  height: 1.1em;
  background-color: var(--color-primary);
  margin-right: 15px;
}

/* CARD */
.review-card {
  background: rgba(12,12,12,0.95);
  border-radius: 16px;
  border: 1px solid #333;
  box-shadow: 0 0 25px rgba(0,0,0,0.6);
  padding: 25px 30px;
}

/* STARS */
.star { font-size: 32px; color:#555; cursor:pointer; transition:0.2s ease; }
.star.active { color:#FFD700; }
.star:hover { color:#FFC300; transform:scale(1.15); }

/* LAYOUT 2 C·ªòT */
.review-layout { display:flex; gap:30px; align-items:flex-start; }
.review-left { flex:1; }
.review-right { flex:1; max-width:450px; }
@media(max-width:992px){ .review-layout { flex-direction:column; } }

/* CUSTOM FILE INPUT */
.hidden-file-input { display:none !important; }
.custom-file-box {
  display:flex; align-items:center; gap:12px; margin-bottom:10px;
}
.btn-upload {
  background-color:#ffcc33; color:#111;
  padding:8px 18px; border-radius:6px; border:1px solid #ffcc33;
  font-weight:600; cursor:pointer; transition:0.25s;
}
.btn-upload:hover { background:transparent; color:#ffcc33; }
.file-name { color:#ccc; font-size:0.95rem; font-style:italic; }
#preview-box img {
  width:120px; height:120px; object-fit:cover;
  border-radius:6px; border:1px solid #444;
}


/* ·∫¢NH THUMBNAIL */
.review-thumb {
  max-width: 250px;
  border: 1px solid #444;
  border-radius: 8px;
  cursor: pointer;
  transition: transform .2s ease, box-shadow .2s ease;
}
.review-thumb:hover {
  transform: scale(1.03);
  box-shadow: 0 0 12px rgba(255,255,255,0.3);
}

/* MODAL PH√ìNG TO ·∫¢NH */
.img-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.img-modal-content {
  max-width: 90%;
  max-height: 90%;
  border-radius: 10px;
  box-shadow: 0 0 25px rgba(0,0,0,0.8);
}

.img-modal-close {
  position: absolute;
  top: 20px;
  right: 30px;
  font-size: 40px;
  color: white;
  cursor: pointer;
}

.remove-preview {
  position:absolute;
  top:-6px;
  right:-6px;
  background:red;
  color:white;
  width:22px;
  height:22px;
  border-radius:50%;
  font-size:14px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:5;
}

.review-scroll {
    max-height: 460px;
    overflow-y: auto;
    padding-right: 6px;
    margin-top: 10px;
}

/* Scrollbar ƒë·∫πp h∆°n */
.review-scroll::-webkit-scrollbar {
    width: 6px;
}
.review-scroll::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 6px;
}
.review-scroll::-webkit-scrollbar-thumb:hover {
    background: #777;
}
.review-scroll::-webkit-scrollbar-track {
    background: #1a1a1a;
}

</style>

<div class="container" style="max-width: 100%;">

  <div class="page-wrap my-4">
    <h2 class="page-title">ƒê√°nh gi√°</h2>
    <p class="text-secondary">H√£y chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n ƒë·ªÉ Star Gym Fitness ph·ª•c v·ª• t·ªët h∆°n</p>
  </div>

  <!-- ‚≠ê‚≠ê 2 C·ªòT ‚≠ê‚≠ê -->
  <div class="review-layout">

      <!-- ================= FORM (C·ªòT TR√ÅI) ================= -->
      <div class="review-card review-left">

        <form method="post" enctype="multipart/form-data" class="text-light text-start mx-auto review-form">
            {% csrf_token %}

            <!-- SAO 1-->
            <div class="mb-3 d-flex align-items-center justify-content-between">
              <label class="form-label mb-0">ƒê√°nh gi√° chung:</label>
              <div class="rating-group" id="rating-chung">
                {% for i in "12345" %}
                  <span class="star" data-value="{{ i }}">‚òÖ</span>
                {% endfor %}
                <input type="hidden" name="danh_gia_chung" id="input-chung" required>
              </div>
            </div>

            <!-- SAO 2 -->
            <div class="mb-3 d-flex align-items-center justify-content-between">
              <label class="form-label mb-0">Th√°i ƒë·ªô ph·ª•c v·ª•:</label>
              <div class="rating-group" id="rating-phucvu">
                {% for i in "12345" %}
                  <span class="star" data-value="{{ i }}">‚òÖ</span>
                {% endfor %}
                <input type="hidden" name="thai_do_phuc_vu" id="input-phucvu" required>
              </div>
            </div>

            <!-- SAO 3 -->
            <div class="mb-3 d-flex align-items-center justify-content-between">
              <label class="form-label mb-0">Ch·∫•t l∆∞·ª£ng d·ªãch v·ª•:</label>
              <div class="rating-group" id="rating-chatluong">
                {% for i in "12345" %}
                  <span class="star" data-value="{{ i }}">‚òÖ</span>
                {% endfor %}
                <input type="hidden" name="chat_luong_dich_vu" id="input-chatluong" required>
              </div>
            </div>

            <!-- NH·∫¨N X√âT -->
            <div class="mb-4">
              <label class="form-label mb-2">Nh·∫≠n x√©t chi ti·∫øt:</label>
              <textarea name="nhan_xet" class="form-control bg-dark text-light border-secondary"
                        rows="4" placeholder="B·∫°n c·∫£m th·∫•y th·∫ø n√†o v·ªÅ kh√¥ng gian, PT, m√°y m√≥c,...?"></textarea>

              {% if da_gui %}
                <p class="fst-italic mt-3 text-center" style="color:#FFD700;">
                  ƒê√°nh gi√° th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°.
                </p>
              {% endif %}
            </div>

            <!-- ================= UPLOAD ·∫¢NH GI·ªêNG GUI.HTML ================= -->
            <div class="mb-4">
              <label class="form-label mb-2">ƒê√≠nh k√®m ·∫£nh (tu·ª≥ ch·ªçn):</label>

              <div class="custom-file-box">
                  <button type="button" class="btn-upload" onclick="document.getElementById('anh_minh_chung').click();">
                      Ch·ªçn ·∫£nh...
                  </button>

                  <span id="file-name" class="file-name">Ch∆∞a c√≥ ·∫£nh n√†o</span>

                  <input type="file" name="anh_minh_chung" accept="image/*" id="anh_minh_chung" class="hidden-file-input" multiple>

              </div>



              <div id="preview-box" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;"></div>
            </div>

            <!-- BUTTON -->
            <div class="d-flex justify-content-center gap-3 mt-3">
              <button type="submit" class="btn btn-warning px-4 fw-semibold">G·ª≠i</button>
              <a href="{% url 'theo_doi' %}" class="btn btn-outline-light px-4">H·ªßy</a>
            </div>

        </form>
      </div>

      <!-- ================= C·ªòT PH·∫¢I ‚Äì ƒê√ÅNH GI√Å G·∫¶N ƒê√ÇY ================= -->
      <div class="review-card review-right">
          <h4 class="text-warning text-center mb-3">ƒê√°nh gi√° g·∫ßn ƒë√¢y</h4>

         <div class="text-light review-scroll">
            {% for dg in danhgias %}
              <div class="border-bottom border-secondary py-3 review-item">

                <div class="d-flex justify-content-between align-items-center mb-1">
                  <p class="text-warning fw-bold mb-0">{{ dg.user.username }}</p>
                  <small class="text-secondary">{{ dg.ngay_tao|date:"d/m/Y H:i" }}</small>
                </div>

                <p class="mb-1">
                  <span class="badge bg-warning text-dark me-2">‚≠ê {{ dg.danh_gia_chung }}/5</span>
                  <span>üí¨ {{ dg.nhan_xet|default:"(Kh√¥ng c√≥ nh·∫≠n x√©t chi ti·∫øt)" }}</span>
                </p>

                {% if dg.images.all %}
<div class="d-flex flex-wrap gap-2 mt-2">
    {% for img in dg.images.all %}
        <img src="{{ img.image.url }}"
             class="img-fluid rounded review-thumb"
             onclick="showImgModal('{{ img.image.url }}')"
             style="max-width:130px;">
    {% endfor %}
</div>
{% endif %}

              </div>
            {% empty %}
              <p class="text-center text-secondary">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
            {% endfor %}
          </div>
      </div>

  </div> <!-- END review-layout -->

</div>

<!-- MODAL -->
<div id="imgModal" class="img-modal" onclick="closeImgModal(event)">
  <span class="img-modal-close">&times;</span>
  <img id="imgModalContent" class="img-modal-content" src="">
</div>

<script>
/* ========== CH·ªåN SAO ========== */
document.addEventListener("DOMContentLoaded", function() {
  function setupRating(groupId, inputId) {
    const stars = document.querySelectorAll(`#${groupId} .star`);
    const input = document.getElementById(inputId);

    stars.forEach((star, index) => {
      star.addEventListener("click", () => {
        input.value = star.dataset.value;
        stars.forEach((s, i) => s.classList.toggle("active", i <= index));
      });
    });
  }

  setupRating("rating-chung", "input-chung");
  setupRating("rating-phucvu", "input-phucvu");
  setupRating("rating-chatluong", "input-chatluong");
});


/* ================================================================
   üî• MULTI IMAGE UPLOAD ‚Äì FULL FUNCTION GI·ªêNG GUI.HTML
================================================================ */
let newImages = [];

const input2 = document.getElementById("anh_minh_chung");
const previewBox2 = document.getElementById("preview-box");
const fileNameText2 = document.getElementById("file-name");

/* Khi ch·ªçn ·∫£nh */
input2.addEventListener("change", () => {
    // Gom t·∫•t c·∫£ ·∫£nh m·ªõi v√†o m·∫£ng
    for (let file of input2.files) newImages.push(file);

    renderPreview();
    refreshInput();
});

/* Render preview t·ª´ng ·∫£nh */
function renderPreview() {
    previewBox2.innerHTML = "";

    newImages.forEach((file, index) => {
        const wrap = document.createElement("div");
        wrap.style = "position:relative; display:inline-block;";

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style = "width:120px;height:120px;object-fit:cover;border-radius:6px;border:1px solid #444;cursor:pointer;";
        img.onclick = () => showImgModal(img.src);

        const remove = document.createElement("div");
        remove.classList.add("remove-preview");
        remove.textContent = "√ó";
        remove.onclick = () => {
            newImages.splice(index, 1);
            renderPreview();
            refreshInput();
        };

        wrap.appendChild(img);
        wrap.appendChild(remove);
        previewBox2.appendChild(wrap);
    });

    fileNameText2.textContent =
        newImages.length > 0 ? `${newImages.length} ·∫£nh ƒë√£ ch·ªçn` : "Ch∆∞a c√≥ ·∫£nh n√†o";
}

/* C·∫≠p nh·∫≠t input.files b·∫±ng DataTransfer */
function refreshInput() {
    const dt = new DataTransfer();
    newImages.forEach(f => dt.items.add(f));
    input2.files = dt.files;
}


/* ================================================================
   üî• MODAL PH√ìNG TO ·∫¢NH
================================================================ */
function showImgModal(src) {
  document.getElementById("imgModalContent").src = src;
  document.getElementById("imgModal").style.display = "flex";
}

function closeImgModal(e) {
  if (e.target.id === "imgModal" || e.target.classList.contains("img-modal-close")) {
    document.getElementById("imgModal").style.display = "none";
  }
}
</script>

{% endblock %}
