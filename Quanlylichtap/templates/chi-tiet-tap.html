{% extends "base-trainer.html" %}
{% block content %}

<style>
/* ... (Style giữ nguyên) ... */
:root {
  --color-primary: #f7c948;
  --color-dark-card: #1a1a1a;
}

.page-title {
  color:#fff;
  font-size:40px;
  font-weight:700;
  margin-bottom:20px;
  display:flex;
  align-items:center;
  text-transform:uppercase;
}
.page-title::before {
  content:''; width:6px;height:1.1em;
  background-color:var(--color-primary);
  margin-right:15px;
}

.hidden-file-input { display:none !important; }
.custom-file-box { display:flex; align-items:center; gap:12px; }

.btn-upload {
  background-color: var(--color-primary);
  color:#111;
  padding:8px 18px;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}
.btn-upload:hover { background:transparent; color:var(--color-primary); }

.file-name { color:#ccc; font-size:0.95rem; font-style:italic; }

.img-wrapper {
  position:relative;
  transition:0.25s;
}
.img-wrapper img {
  width:110px;height:110px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #444;
}
.btn-del-img {
  position:absolute; top:-6px; right:-6px;
  width:22px;height:22px;
  background:#e63946;
  border:none;
  border-radius:50%;
  color:white;
  cursor:pointer;
  font-size:14px;
  font-weight:bold;
}

.btn-save, .btn-back {
  background-color:var(--color-primary);
  color:#111; padding:10px 22px;
  border-radius:8px;
  font-weight:600;
}
.btn-save:hover, .btn-back:hover {
  background:transparent; color:var(--color-primary);
}
</style>


<div style="width:100%;padding:30px;color:white;display:flex;gap:40px;align-items:flex-start;">

    <div style="flex:1.4;">

        <h2 class="page-title">Thông tin buổi tập</h2>
        <div style="background:#1e1e1e;padding:20px;border-radius:12px;margin-bottom:30px;">
            <p><b>Học viên:</b> {{ buoi_tap.hoc_vien }}</p>
            <p><b>Ngày tập:</b> {{ buoi_tap.ngay_tap }}</p>
            <p><b>Bài tập:</b> {{ buoi_tap.bai_tap }}</p>
            <p><b>Trạng thái:</b> {{ buoi_tap.trang_thai }}</p>
        </div>

        <h4 class="page-title" style="font-size: 24px;">Lịch sử tập luyện</h4>
        <div style="max-height: 400px; overflow-y: auto;">
        {% for item in lich_su %}
            <div class="card mb-3 p-3" style="background:#1e1e1e;padding:20px;border-radius:10px;margin-top:15px;color:white">
                <b>{{ item.ngay_tap|date:"M d, Y" }}</b> - {{ item.bai_tap }} ({{ item.trang_thai }})

                {% if item.nx %}
                <div class="mt-2">
                    <b>Nhận xét:</b> {{ item.nx.ngay_nhan_xet|date:"d/m/Y H:i" }}<br>
                    {{ item.nx.noi_dung }}
                </div>
                {% else %}
                <div class="mt-2" style="color:white">
                    <b>Nhận xét:</b> Chưa có
                </div>
                {% endif %}
            </div>
        {% endfor %}
        </div>
    </div>

    <div style="flex:1;">

        <h3>Nhận xét của HLV</h3>

        {% if not nhan_xet.noi_dung %}
        <div id="no-cmt">
            <p style="color:#bbb;">Chưa có nhận xét.</p>
            <button class="btn-save" id="btn-add">Thêm nhận xét</button>
        </div>
        {% endif %}


        <div id="form-box"
             style="display:none;background:#1a1a1a;padding:25px;border-radius:12px;
                    max-width:520px;box-shadow:0 0 12px rgba(247,201,72,0.15);">

            <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <label>Nội dung nhận xét:</label>

<textarea name="noi_dung" rows="5"
 style="width:100%;background:#2b2e31;color:white;border:1px solid #555;
        border-radius:6px;padding:10px;">{{ nhan_xet.noi_dung|default:'' }}</textarea>


            <label style="margin-top:12px;">Thêm ảnh mới:</label>

            <div class="custom-file-box">
                <button type="button" class="btn-upload"
                        onclick="document.getElementById('anh').click()">Chọn ảnh...</button>

                <span id="file-name" class="file-name">Chưa có ảnh nào</span>

                <input type="file" id="anh" name="hinh_anh" class="hidden-file-input" multiple accept="image/*">
            </div>

            <div id="preview-box"
                 style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;">
            </div>


            <input type="hidden" name="delete_list" id="delete_list">

            <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;">
                {% for img in hinh_anh_list %}
                <div class="img-wrapper" id="img-wrap-{{ img.id }}">
                    <img src="{{ img.anh.url }}" onclick="openImgModal('{{ img.anh.url }}')" style="cursor:pointer;">

                    <button type="button" class="btn-del-img"
                            onclick="deleteImage({{ img.id }})">×</button>
                </div>
                {% endfor %}
            </div>


            <button type="submit" class="btn-save" style="margin-top:15px;">Lưu thay đổi</button>
            <button type="button" id="btn-cancel" class="btn-back" style="margin-left:10px;">Hủy</button>

            </form>
        </div>


        {% if nhan_xet.noi_dung %}
        <div id="view-box"
             style="max-width:520px;background:#1a1a1a;padding:20px;border-radius:12px;margin-top:10px;">

            <p style="white-space:pre-line;">{{ nhan_xet.noi_dung }}</p>

            <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;">
                {% for img in hinh_anh_list %}
                <img src="{{ img.anh.url }}"
     onclick="openImgModal('{{ img.anh.url }}')"
     style="cursor:pointer;width:110px;height:110px;border-radius:6px;border:1px solid #444;object-fit:cover;">

                {% endfor %}
            </div>

            <button id="btn-edit" class="btn-save" style="margin-top:15px;">Chỉnh sửa</button>
        </div>
        {% endif %}

    </div>
</div>

<div id="imgModal" style="
    display:none;
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.85);
    justify-content:center;
    align-items:center;
    z-index:99999;">

    <img id="modalImg" style="
        max-width:90%;
        max-height:90%;
        border-radius:10px;
        box-shadow:0 0 25px rgba(255,255,255,0.3);
        animation:zoomIn 0.25s ease;">
</div>

<style>
@keyframes zoomIn {
  from { transform:scale(0.6); opacity:0; }
  to   { transform:scale(1); opacity:1; }
}
</style>

<script>
// ... (TOÀN BỘ CODE JAVASCRIPT GIỮ NGUYÊN) ...
let newImages = [];
let deleteList = [];

const input = document.getElementById("anh");
const preview = document.getElementById("preview-box");
const fileName = document.getElementById("file-name");
const deleteInput = document.getElementById("delete_list");

const formBox = document.getElementById("form-box");
const noCmt   = document.getElementById("no-cmt");
const viewBox = document.getElementById("view-box");
const btnAdd  = document.getElementById("btn-add");
const btnEdit = document.getElementById("btn-edit");
const btnCancel = document.getElementById("btn-cancel");


/* ==================== MULTI SELECT NEW IMAGE ==================== */
if (input) {
    input.addEventListener("change", () => {
        for (let f of input.files) newImages.push(f);
        renderPreview();
        refreshFileInput();
    });
}


/* ==================== RENDER PREVIEW ==================== */
function renderPreview() {
    preview.innerHTML = "";

    newImages.forEach((file, index) => {
        const box = document.createElement("div");
        box.style = "position:relative;width:110px;height:110px;";

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.cursor = "pointer";
        img.onclick = () => openImgModal(img.src);

        img.style =
            "width:110px;height:110px;border-radius:6px;object-fit:cover;border:1px solid #444;";

        const del = document.createElement("button");
        del.textContent = "×";
        del.style =
            `position:absolute;top:-6px;right:-6px;width:22px;height:22px;
             background:#e63946;color:white;border:none;border-radius:50%;cursor:pointer;`;
        del.onclick = () => {
            newImages.splice(index, 1);
            renderPreview();
            refreshFileInput();
        };

        box.appendChild(img);
        box.appendChild(del);
        preview.appendChild(box);
    });

    fileName.textContent = newImages.length
        ? `${newImages.length} ảnh đã chọn`
        : "Chưa có ảnh nào";
}


/* ==================== UPDATE FILE INPUT ==================== */
function refreshFileInput() {
    const dt = new DataTransfer();
    newImages.forEach(f => dt.items.add(f));
    input.files = dt.files;
}


/* ==================== DELETE OLD IMAGE ==================== */
function deleteImage(id) {
    if (!confirm("Xóa ảnh này?")) return;

    const box = document.getElementById("img-wrap-" + id);
    if (box) {
        box.style.opacity = "0.3";
        setTimeout(() => {
            box.style.display = "none";
        }, 200);
    }

    deleteList.push(id);
    deleteInput.value = deleteList.join(",");
}


/* ==================== SHOW / HIDE FORM ==================== */
if (btnAdd)
    btnAdd.onclick = () => {
        formBox.style.display = "block";
        if (noCmt) noCmt.style.display = "none";
    };

if (btnEdit)
    btnEdit.onclick = () => {
        formBox.style.display = "block";
        if (viewBox) viewBox.style.display = "none";
    };

if (btnCancel)
    btnCancel.onclick = () => {
        formBox.style.display = "none";
        newImages = [];
        deleteList = [];
        preview.innerHTML = "";
        fileName.textContent = "Chưa có ảnh nào";

        if (noCmt) noCmt.style.display = "block";
        if (viewBox) viewBox.style.display = "block";
    };

function openImgModal(src) {
    document.getElementById("modalImg").src = src;
    document.getElementById("imgModal").style.display = "flex";
}

document.getElementById("imgModal").onclick = function(e) {
    if (e.target.id === "imgModal") {
        document.getElementById("imgModal").style.display = "none";
    }
};

</script>

<script>
function openImgModal(src) {
    document.getElementById("modalImg").src = src;
    document.getElementById("imgModal").style.display = "flex";
}

document.getElementById("imgModal").onclick = function(e) {
    if (e.target.id === "imgModal") {
        document.getElementById("imgModal").style.display = "none";
    }
};
</script>

{% endblock %}