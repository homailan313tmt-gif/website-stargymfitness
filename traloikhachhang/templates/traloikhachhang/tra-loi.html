{% extends "base-staff.html" %}
{% block title %}Tr·∫£ l·ªùi ph·∫£n h·ªìi{% endblock %}

{% block content %}

<Style>
:root {
  --color-primary: #f7c948;
  --color-text-light: #fff;
  --color-text-secondary: #cfcfcf;
  --color-dark-card: #222;
  --color-darker-card: #1a1a1a;
}

/* --- 1. Ti√™u ƒë·ªÅ Highlight (Page Title) --- */
.page-title {
  color:#fff;
  font-size: 40px;
  font-weight: 700;
  margin-bottom: 22px;
  display: flex;
  align-items: center;
  text-align:left;
  text-transform: uppercase;
}

.page-title::before {
  content: '';
  display: block;
  width: 6px;
  height: 1.1em;
  background-color: var(--color-primary);
  margin-right: 15px;
}

/* üî• FIX CARET L·ªÜCH TRONG TEXTAREA */
#textarea_reply {
    padding-left: 10px !important;
    text-indent: 0 !important;
    line-height: 1.4 !important;
    caret-color: #fff;
}
</Style>

<div class="page-wrap my-4" style="min-height:70vh;">
    <h2 class="page-title">Tr·∫£ l·ªùi ph·∫£n h·ªìi</h2>

    {% if ph.user %}
        <p>
            <strong>Kh√°ch h√†ng:</strong>
            {% if ph.user.get_full_name %}
                {{ ph.user.get_full_name }}
            {% else %}
                {{ ph.user.username }}
            {% endif %}
        </p>
    {% else %}
        <p><strong>Kh√°ch h√†ng:</strong> Kh√°ch l·∫ª (kh√¥ng ƒëƒÉng nh·∫≠p)</p>
    {% endif %}

    <p><strong>Ng√†y:</strong> {{ ph.ngay_gui|date:"d-m-Y" }}</p>
    <p><strong>Lo·∫°i ph·∫£n h·ªìi:</strong> {{ ph.loai }}</p>
    <p><strong>N·ªôi dung:</strong> {{ ph.noi_dung }}</p>

{% if ph.ds_anh.all %}
<div class="mt-3">
    <strong>·∫¢nh kh√°ch g·ª≠i:</strong>

    <div style="display:flex; flex-wrap:wrap; gap:12px; margin-top:12px;">
        {% for img in ph.ds_anh.all %}
        <div style="position:relative;">
            <img src="{{ img.anh.url }}"
                 style="
                     width:140px;
                     height:140px;
                     object-fit:cover;
                     border-radius:10px;
                     border:1px solid #444;
                     transition:0.25s;">
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if first_time %}
<p class="mt-3" style="color:#f7c948; font-style: italic;">
    ƒê√¢y l√† ph·∫£n h·ªìi ƒë·∫ßu ti√™n c·ªßa kh√°ch h√†ng n√†y.
</p>
{% endif %}

<form method="post" class="mt-4">
    {% csrf_token %}

    <div class="mb-3">
        <label class="form-label">Tr·∫°ng th√°i</label>
        <select name="trang_thai" id="select_status"
                class="form-select bg-dark text-light"
                {% if ph.trang_thai == "ƒê√£ x·ª≠ l√Ω" %}disabled{% endif %}>
            <option value="Ch∆∞a x·ª≠ l√Ω"
                    {% if ph.trang_thai == 'Ch∆∞a x·ª≠ l√Ω' %}selected{% endif %}>
                Ch∆∞a x·ª≠ l√Ω
            </option>
            <option value="ƒê√£ x·ª≠ l√Ω"
                    {% if ph.trang_thai == 'ƒê√£ x·ª≠ l√Ω' %}selected{% endif %}>
                ƒê√£ x·ª≠ l√Ω
            </option>
        </select>
    </div>

    <div class="mb-3">
    <label class="form-label">Tr·∫£ l·ªùi ph·∫£n h·ªìi</label>

    <textarea name="tra_loi" rows="4"
        id="textarea_reply"
        class="form-control bg-dark text-light"
        {% if ph.trang_thai == "ƒê√£ x·ª≠ l√Ω" %}readonly{% endif %}>{{ ph.tra_loi|default_if_none:"" }}</textarea>

    {% if updated %}
        <p class="mt-2" style="color:#f7c948; font-style:italic;">
            C·∫≠p nh·∫≠t th√†nh c√¥ng!
        </p>
    {% endif %}
</div>


    <div class="d-flex gap-3 justify-content-center">
        {% if ph.trang_thai == "ƒê√£ x·ª≠ l√Ω" %}
            <button type="button" id="btn_edit" class="btn btn-warning px-4 fw-semibold">Ch·ªânh s·ª≠a</button>
            <button type="submit" id="btn_save" class="btn btn-warning px-4 fw-semibold" style="display:none;">L∆∞u</button>

        {% else %}
            <button type="submit" class="btn btn-warning px-4 fw-semibold">G·ª≠i</button>
        {% endif %}
        <a href="{% url 'theo-doi-phan-hoi' %}" class="btn btn-outline-light px-4">H·ªßy</a>
    </div>

</form>

{% if history %}
<h3 class="mt-5 mb-3 text-warning">
    L·ªãch s·ª≠ ph·∫£n h·ªìi c·ªßa
    {% if ph.user %}
        {% if ph.user.get_full_name %}
            {{ ph.user.get_full_name }}
        {% else %}
            {{ ph.user.username }}
        {% endif %}
    {% else %}
        Kh√°ch l·∫ª
    {% endif %}
</h3>


<table class="table table-dark table-hover align-middle">
    <thead class="border-bottom border-warning">
        <tr>
            <th>M√£ ph·∫£n h·ªìi</th>
            <th>Ng√†y</th>
            <th>Lo·∫°i</th>
            <th>Tr·∫°ng th√°i</th>
            <th>N·ªôi dung</th>
        </tr>
    </thead>
    <tbody>
        {% for h in history %}
        <tr onclick="window.location.href='{% url 'tra_loi_chi_tiet' h.id %}'" style="cursor:pointer;">
            <td>{{ h.id }}</td>
            <td>{{ h.ngay_gui|date:"d-m-Y" }}</td>
            <td>{{ h.loai }}</td>
            <td>
                {% if h.trang_thai == 'Ch∆∞a x·ª≠ l√Ω' %}
                    <span class="badge bg-danger">Ch∆∞a x·ª≠ l√Ω</span>
                {% else %}
                    <span class="badge bg-success">ƒê√£ x·ª≠ l√Ω</span>
                {% endif %}
            </td>
            <td>{{ h.noi_dung|truncatechars:80 }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<div id="img-popup"
     style="
        display:none;
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.85);
        justify-content:center;
        align-items:center;
        z-index:2000;">
    <img id="popup-img"
         style="max-width:90%; max-height:90%; border-radius:12px; border:2px solid #fff;">
</div>


</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const btnEdit = document.getElementById("btn_edit");
    const btnSave = document.getElementById("btn_save");
    const textarea = document.getElementById("textarea_reply");
    const selectStatus = document.getElementById("select_status");

    if (btnEdit) {
        btnEdit.addEventListener("click", function () {
            textarea.removeAttribute("readonly");
            selectStatus.removeAttribute("disabled");
            btnEdit.style.display = "none";
            btnSave.style.display = "inline-block";
        });
    }
});

document.addEventListener("DOMContentLoaded", function () {

    /* ====== PH√ìNG TO ·∫¢NH ====== */
    const popup = document.getElementById("img-popup");
    const popupImg = document.getElementById("popup-img");

    document.querySelectorAll("img").forEach(img => {
        img.addEventListener("click", () => {
            popupImg.src = img.src;
            popup.style.display = "flex";
        });
    });

    popup.addEventListener("click", () => {
        popup.style.display = "none";
    });

});
</script>

{% endblock %}
